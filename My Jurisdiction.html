<script>
    // GraphQL queries for jurisdiction data
    var READ_JURISDICTION_QUERY = `
    query GetJurisdiction($databaseId: Int!) {
      jurisdictions(where: {id: $databaseId}) {
        edges {
          node {
            id
            databaseId
            title
            jurisdictionDetails {
              addressJurisdiction
              agencyName
              faxJurisdiction
              fipsCode
              phoneJurisdiction
            }
            modified
          }
        }
      }
    }
    `;
    
    var UPDATE_JURISDICTION_QUERY = `
    mutation UpdateJurisdiction($input: UpdateJurisdictionInput!) {
      updateJurisdiction(input: $input) {
        jurisdiction {
          id
          databaseId
          title
          jurisdictionDetails {
            addressJurisdiction
            agencyName
            faxJurisdiction
            fipsCode
            phoneJurisdiction
          }
        }
      }
    }
    `;

    var CREATE_JURISDICTION_QUERY = `
    mutation CreateJurisdiction($input: CreateJurisdictionInput!) {
      createJurisdiction(input: $input) {
        jurisdiction {
          id
          databaseId
          title
          jurisdictionDetails {
            addressJurisdiction
            agencyName
            faxJurisdiction
            fipsCode
            phoneJurisdiction
          }
        }
      }
    }
    `;

    var DELETE_JURISDICTION_QUERY = `
    mutation DeleteJurisdiction($input: DeleteJurisdictionInput!) {
      deleteJurisdiction(input: $input) {
        jurisdiction {
          id
          databaseId
        }
        deleted
      }
    }
    `;
    
    var READ_USERS_QUERY = `
    query GetUsersByJurisdiction($jurisdictionId: Int!) {
      users(where: {jurisdictionDatabaseId: $jurisdictionId}) {
        nodes {
          firstName
          lastName
          email
          stdContactDetails {
            confidentialPhone
            userPhone
            userFax
            notesStiHiv
            stiRole {
              nodes {
                name
                id
                databaseId
              }
            }
            hivRole {
              nodes {
                name
                id
                databaseId
              }
            }
          }
          id
          databaseId
        }
      }
    }
    `;

    var UPDATE_USER_QUERY = `
    mutation UpdateUserStdContact($input: UpdateUserStdContactInput!) {
      updateUserStdContact(input: $input) {
        user {
          id
          databaseId
          firstName
          lastName
          email
          stdContactDetails {
            confidentialPhone
            userPhone
            userFax
            notesStiHiv
            hivRole {
              nodes {
                id
                databaseId
                name
              }
            }
            stiRole {
              nodes {
                id
                databaseId
                name
              }
            }
          }
        }
      }
    }
    `;

    var CREATE_USER_QUERY = `
    mutation CreateUser($input: CreateUserInput!) {
      createUser(input: $input) {
        user {
          id
          databaseId
          firstName
          lastName
          email
          stdContactDetails {
            confidentialPhone
            userPhone
            userFax
            notesStiHiv
            hivRole {
              nodes {
                id
                databaseId
                name
              }
            }
            stiRole {
              nodes {
                id
                databaseId
                name
              }
            }
          }
        }
      }
    }
    `;

    var DELETE_USER_QUERY = `
    mutation DeleteUser($input: DeleteUserInput!) {
      deleteUser(input: $input) {
        deletedId
      }
    }
    `;

    var GET_HIV_ROLES_QUERY = `
    query GetHivRoles {
      hIVRoles {
        nodes {
          id
          databaseId
          name
        }
      }
    }
    `;

    var GET_STI_ROLES_QUERY = `
    query GetStiRoles {
      sTIRoles {
        nodes {
          name
          databaseId
          id
        }
      }
    }
    `;

    var GET_CURRENT_USER_JURISDICTION_QUERY = `
    query CurrentUserJurisdiction {
      viewer {
        stdContactDetails {
          userJurisdiction {
            nodes {
              databaseId
              id
              ... on Jurisdiction {
                id
                title
                jurisdictionDetails {
                  addressJurisdiction
                  agencyName
                  faxJurisdiction
                  fipsCode
                  phoneJurisdiction
                }
              }
            }
          }
        }
      }
    }
    `;

    // Global variables for storing role data
    var hivRolesData = [];
    var stiRolesData = [];
    var currentJurisdictionId = null;
    
    // Function to generate secure passwords with required complexity
    function generateSecurePassword() {
        var upperChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        var lowerChars = 'abcdefghijklmnopqrstuvwxyz';
        var numbers = '0123456789';
        var specialChars = '!@#$%^&*()_+[]{}|;:,.<>?';
        
        var allChars = upperChars + lowerChars + numbers + specialChars;
        var password = '';
        
        // Ensure at least one of each required character type
        password += upperChars.charAt(Math.floor(Math.random() * upperChars.length));
        password += lowerChars.charAt(Math.floor(Math.random() * lowerChars.length));
        password += numbers.charAt(Math.floor(Math.random() * numbers.length));
        password += specialChars.charAt(Math.floor(Math.random() * specialChars.length));
        
        // Fill the rest with random characters
        for (var i = 0; i < 4; i++) {
            password += allChars.charAt(Math.floor(Math.random() * allChars.length));
        }
        
        // Shuffle the password characters
        return password.split('').sort(function() { 
            return 0.5 - Math.random(); 
        }).join('');
    }

    // Function to show notifications
    function showNotification(message, type = 'error') {
        if (window.kendo && kendo.ui.Notification) {
            const notification = new kendo.ui.Notification({
                position: { top: 30, right: 30 }
            });
            notification[type](message);
        } else {
            console[type === 'error' ? 'error' : 'log'](message);
        }
    }

    $(document).ready(function() {
        // First fetch current user's jurisdiction
        $.ajax({
            url: 'https://hivstiooj.cste.org/graphql',
            method: 'POST',
            data: JSON.stringify({ query: GET_CURRENT_USER_JURISDICTION_QUERY }),
            contentType: 'application/json',
            dataType: 'json',
            xhrFields: { withCredentials: true },
            headers: { 'Accept': 'application/json' }
        }).then(function(response) {
            if (response.errors) {
                console.error('GraphQL errors:', response.errors);
                showNotification('Error: ' + response.errors[0].message);
                return;
            }

            const jurisdictionNode = response?.data?.viewer?.stdContactDetails?.userJurisdiction?.nodes?.[0];
            if (!jurisdictionNode) {
                showNotification("Could not determine user's jurisdiction");
                return;
            }

            currentJurisdictionId = jurisdictionNode.databaseId;
            console.log('Using jurisdictionId:', currentJurisdictionId);

            // Then fetch HIV and STI roles
            Promise.all([
                $.ajax({
                    url: 'https://hivstiooj.cste.org/graphql',
                    method: 'POST',
                    data: JSON.stringify({ query: GET_HIV_ROLES_QUERY }),
                    contentType: 'application/json',
                    dataType: 'json',
                    xhrFields: { withCredentials: true }
                }),
                $.ajax({
                    url: 'https://hivstiooj.cste.org/graphql',
                    method: 'POST',
                    data: JSON.stringify({ query: GET_STI_ROLES_QUERY }),
                    contentType: 'application/json',
                    dataType: 'json',
                    xhrFields: { withCredentials: true }
                })
            ]).then(function(results) {
                // Store roles data
                if (results[0].data && results[0].data.hIVRoles) {
                    hivRolesData = results[0].data.hIVRoles.nodes;
                }
                if (results[1].data && results[1].data.sTIRoles) {
                    stiRolesData = results[1].data.sTIRoles.nodes;
                }

                // Initialize grids
                initJurisdictionGrid();
                initUsersGrid();
            }).catch(function(error) {
                console.error("Error fetching roles:", error);
                showNotification("Failed to load roles data");
            });
        }).catch(function(error) {
            console.error("Error getting jurisdiction:", error);
            showNotification("Failed to determine user's jurisdiction");
        });

        function initJurisdictionGrid() {
            // JURISDICTION GRID DATASOURCE
            var jurisdictionDataSource = new kendo.data.DataSource({
                autoSync: false, // Disable auto sync - require manual save
                transport: {
                    create: {
                        contentType: "application/json",
                        url: "https://hivstiooj.cste.org/graphql",
                        type: "POST",
                        data: function(model) {
                            return {
                                query: CREATE_JURISDICTION_QUERY,
                                variables: {
                                    "input": {
                                        "title": model.title.rendered,
                                        "status": "publish",
                                        "agencyName": model.jurisdictionDetails.agencyName,
                                        "addressJurisdiction": model.jurisdictionDetails.addressJurisdiction,
                                        "phoneJurisdiction": model.jurisdictionDetails.phoneJurisdiction,
                                        "fipsCode": model.jurisdictionDetails.fipsCode,
                                        "faxJurisdiction": model.jurisdictionDetails.faxJurisdiction
                                    }
                                }
                            };
                        }
                    },
                    read: {
                        contentType: "application/json",
                        url: "https://hivstiooj.cste.org/graphql",
                        type: "POST",
                        data: function() {
                            return {
                                query: READ_JURISDICTION_QUERY,
                                variables: { "databaseId": currentJurisdictionId }
                            };
                        }
                    },
                    update: {
                        contentType: "application/json",
                        url: "https://hivstiooj.cste.org/graphql",
                        type: "POST",
                        data: function(model) {
                            const globalId = btoa(`post:${model.databaseId}`);
                            return {
                                query: UPDATE_JURISDICTION_QUERY,
                                variables: {
                                    "input": {
                                        "id": globalId,
                                        "title": model.title.rendered,
                                        "agencyName": model.jurisdictionDetails.agencyName,
                                        "addressJurisdiction": model.jurisdictionDetails.addressJurisdiction,
                                        "phoneJurisdiction": model.jurisdictionDetails.phoneJurisdiction,
                                        "fipsCode": model.jurisdictionDetails.fipsCode,
                                        "faxJurisdiction": model.jurisdictionDetails.faxJurisdiction
                                    }
                                }
                            };
                        }
                    },
                    destroy: {
                        contentType: "application/json",
                        url: "https://hivstiooj.cste.org/graphql",
                        type: "POST",
                        data: function(model) {
                            return {
                                query: DELETE_JURISDICTION_QUERY,
                                variables: {
                                    "input": {
                                        "id": model.id,
                                        "forceDelete": true
                                    }
                                }
                            };
                        }
                    },
                    parameterMap: function(options, operation) {
                        return kendo.stringify({
                            query: options.query,
                            variables: options.variables
                        });
                    }
                },
                schema: {
                    data: function(response) {
                        if (response.errors && response.errors.length > 0) {
                            showNotification('Error: ' + response.errors[0].message);
                            return [];
                        }
                        
                        var data = response.data;
                        if (!data) return [];

                        // Handle different response types
                        if (data.jurisdictions && data.jurisdictions.edges) {
                            return data.jurisdictions.edges.map(edge => {
                                const node = edge.node;
                                return {
                                    id: node.id,
                                    databaseId: node.databaseId,
                                    title: { rendered: node.title },
                                    modified: node.modified,
                                    jurisdictionDetails: node.jurisdictionDetails
                                };
                            });
                        }
                        else if (data.createJurisdiction && data.createJurisdiction.jurisdiction) {
                            const jurisdiction = data.createJurisdiction.jurisdiction;
                            return [{
                                id: jurisdiction.id,
                                databaseId: jurisdiction.databaseId,
                                title: { rendered: jurisdiction.title },
                                modified: new Date().toISOString(),
                                jurisdictionDetails: jurisdiction.jurisdictionDetails
                            }];
                        }
                        else if (data.updateJurisdiction && data.updateJurisdiction.jurisdiction) {
                            const jurisdiction = data.updateJurisdiction.jurisdiction;
                            return [{
                                id: jurisdiction.id,
                                databaseId: jurisdiction.databaseId,
                                title: { rendered: jurisdiction.title },
                                modified: new Date().toISOString(),
                                jurisdictionDetails: jurisdiction.jurisdictionDetails
                            }];
                        }
                        else if (data.deleteJurisdiction && data.deleteJurisdiction.deleted) {
                            return [];
                        }
                        
                        return [];
                    },
                    model: {
                        id: "id",
                        fields: {
                            id: { editable: false, nullable: true },
                            databaseId: { editable: false, nullable: true },
                            title: { defaultValue: { rendered: "" } },
                            modified: { type: "string", editable: false },
                            jurisdictionDetails: {
                                defaultValue: {
                                    agencyName: "",
                                    addressJurisdiction: "",
                                    phoneJurisdiction: "",
                                    fipsCode: "",
                                    faxJurisdiction: ""
                                }
                            }
                        }
                    }
                },
                pageSize: 20
            });

            $("#juris_grid").kendoGrid({
                dataSource: jurisdictionDataSource,
                height: 175,
                sortable: true,
                toolbar: ["save", "cancel"],
                editable: "inline",
                save: function(e) {
                    console.log("Jurisdiction grid save event triggered", e);
                    // Manually sync when save is clicked
                    jurisdictionDataSource.sync();
                },
                columns: [
                    { field: "title.rendered", title: "Jurisdiction Name" },
                    { field: "jurisdictionDetails.fipsCode", title: "FIPS Code" },
                    { field: "jurisdictionDetails.agencyName", title: "Agency Name" },
                    { field: "jurisdictionDetails.addressJurisdiction", title: "Agency Address" },
                    { field: "jurisdictionDetails.phoneJurisdiction", title: "Agency Phone (Main)" },
                    { field: "jurisdictionDetails.faxJurisdiction", title: "Agency Fax" },
                    { command: ["edit"], title: "&nbsp;", width: "250px" }
                ]
            });
        }

        function initUsersGrid() {
            // USERS GRID DATASOURCE
            var usersDataSource = new kendo.data.DataSource({
                autoSync: false, // Disable auto sync - require manual save
                batch: false,   // Process updates immediately, not in batches
                transport: {
                    create: {
                        contentType: "application/json",
                        url: "https://hivstiooj.cste.org/graphql",
                        type: "POST",
                        data: function(model) {
                            // Extract role IDs and ensure integer format
                            const hivRoleIds = Array.isArray(model.hivRole) ? 
                                model.hivRole.map(role => {
                                    const id = typeof role === 'object' ? role.databaseId : role;
                                    return parseInt(id, 10);
                                }) : [];
                            
                            const stiRoleIds = Array.isArray(model.stiRole) ? 
                                model.stiRole.map(role => {
                                    const id = typeof role === 'object' ? role.databaseId : role;
                                    return parseInt(id, 10);
                                }) : [];
                            
                            // Generate a secure password for the new user
                            const securePassword = generateSecurePassword();
                            console.log('Generated secure password:', securePassword);
                            
                            // Generate username based on email (default) or first+last name
                            let username = "";
                            if (model.email) {
                                // Generate username from email by removing the domain part
                                username = model.email.split('@')[0];
                            } else if (model.firstName && model.lastName) {
                                // Generate username from first name + last name
                                username = (model.firstName + "." + model.lastName).toLowerCase();
                            } else {
                                // Fallback to a timestamp-based username
                                username = "user_" + new Date().getTime();
                            }
                            // Sanitize username (remove special chars and spaces)
                            username = username.replace(/[^a-zA-Z0-9._-]/g, "");
                            console.log('Generated username:', username);
                            
                            // Step 1: Create user with core fields only
                            console.log('CREATE USER with data:', model);
                            
                            // Store the full model data for the second step using closure variables
                            // Make these accessible to the schema.data callback later
                            window.tempUserCreationData = {
                                fullModel: {
                                    confidentialPhone: model.confidentialPhone || "",
                                    userPhone: model.userPhone || "",
                                    userFax: model.userFax || "",
                                    notesStiHiv: model.notesStiHiv || ""
                                },
                                fullHivRoleIds: hivRoleIds,
                                fullStiRoleIds: stiRoleIds
                            };
                            
                            // Only include the standard WordPress fields in the mutation
                            const createPayload = {
                                query: CREATE_USER_QUERY,
                                variables: {
                                    "input": {
                                        "username": username,
                                        "firstName": model.firstName || "",
                                        "lastName": model.lastName || "",
                                        "email": model.email || "",
                                        "password": securePassword
                                    }
                                }
                            };
                            
                            console.log('CREATE USER GraphQL payload:', JSON.stringify(createPayload, null, 2));
                            return createPayload;
                        }
                    },
                    read: {
                        contentType: "application/json",
                        url: "https://hivstiooj.cste.org/graphql",
                        type: "POST",
                        data: function() {
                            return {
                                query: READ_USERS_QUERY,
                                variables: { "jurisdictionId": parseInt(currentJurisdictionId, 10) }
                            };
                        }
                    },
                    update: {
                        contentType: "application/json",
                        url: "https://hivstiooj.cste.org/graphql",
                        type: "POST",
                        data: function(model) {
                            // Extract role IDs and ensure integer format
                            const hivRoleIds = Array.isArray(model.hivRole) ? 
                                model.hivRole.map(role => {
                                    const id = typeof role === 'object' ? role.databaseId : role;
                                    return parseInt(id, 10);
                                }) : [];
                            
                            const stiRoleIds = Array.isArray(model.stiRole) ? 
                                model.stiRole.map(role => {
                                    const id = typeof role === 'object' ? role.databaseId : role;
                                    return parseInt(id, 10);
                                }) : [];
                            
                            console.log('UPDATE USER with data:', model);
                            console.log('hivRoleIds:', hivRoleIds);
                            console.log('stiRoleIds:', stiRoleIds);
                            
                            return {
                                query: UPDATE_USER_QUERY,
                                variables: {
                                    "input": {
                                        "userId": parseInt(model.databaseId, 10),
                                        "firstName": model.firstName || "",
                                        "lastName": model.lastName || "",
                                        "email": model.email || "",
                                        "confidentialPhone": model.confidentialPhone || "",
                                        "userPhone": model.userPhone || "",
                                        "userFax": model.userFax || "",
                                        "notesStiHiv": model.notesStiHiv || "",
                                        "hivRole": hivRoleIds,
                                        "stiRole": stiRoleIds,
                                        "userJurisdiction": parseInt(currentJurisdictionId, 10)
                                    }
                                }
                            };
                        }
                    },
                    destroy: {
                        contentType: "application/json",
                        url: "https://hivstiooj.cste.org/graphql",
                        type: "POST",
                        data: function(model) {
                            return {
                                query: DELETE_USER_QUERY,
                                variables: {
                                    "input": {
                                        "id": model.id
                                        // forceDelete removed as it's not supported by the schema
                                    }
                                }
                            };
                        }
                    },
                    parameterMap: function(options, operation) {
                        console.log('parameterMap for users with operation:', operation, 'options:', options);
                        
                        // For update operations, make sure we're using the current model state
                        if (operation === 'update' && options.models) {
                            console.log('Preparing update for models:', options.models);
                        }
                        
                        const payload = kendo.stringify({
                            query: options.query,
                            variables: options.variables
                        });
                        console.log('Sending payload:', payload);
                        return payload;
                    }
                },
                schema: {
                    data: function(response) {
                        console.log('User response received:', response);
                        if (response.errors && response.errors.length > 0) {
                            console.error('GraphQL errors:', response.errors);
                            showNotification('Error: ' + response.errors[0].message);
                            return [];
                        }
                        
                        var data = response.data;
                        if (!data) return [];

                        // Handle user read operation
                        if (data.users && data.users.nodes) {
                            return data.users.nodes.map(node => {
                                return {
                                    id: node.id,
                                    databaseId: node.databaseId,
                                    firstName: node.firstName || "",
                                    lastName: node.lastName || "",
                                    email: node.email || "",
                                    confidentialPhone: node.stdContactDetails?.confidentialPhone || "",
                                    userPhone: node.stdContactDetails?.userPhone || "",
                                    userFax: node.stdContactDetails?.userFax || "",
                                    notesStiHiv: node.stdContactDetails?.notesStiHiv || "",
                                    hivRole: node.stdContactDetails?.hivRole?.nodes || [],
                                    stiRole: node.stdContactDetails?.stiRole?.nodes || []
                                };
                            });
                        }
                        // Handle user create operation
                        else if (data.createUser && data.createUser.user) {
                            const user = data.createUser.user;
                            
                            // Step 2: Now that user is created, update with custom fields
                            console.log('User created successfully, now updating custom fields...');
                            
                            // Get the stored data from step 1
                            const storedData = window.tempUserCreationData || {};
                            
                            // Create a shallow copy to avoid model mutation warnings
                            const newUser = {
                                id: user.id,
                                databaseId: user.databaseId,
                                firstName: user.firstName || "",
                                lastName: user.lastName || "",
                                email: user.email || "",
                                confidentialPhone: storedData.fullModel?.confidentialPhone || "",
                                userPhone: storedData.fullModel?.userPhone || "",
                                userFax: storedData.fullModel?.userFax || "",
                                notesStiHiv: storedData.fullModel?.notesStiHiv || "",
                                hivRole: [],  // Will be populated after update
                                stiRole: []   // Will be populated after update
                            };
                            
                            // Prepare the update mutation payload
                            const updatePayload = {
                                query: UPDATE_USER_QUERY,
                                variables: {
                                    "input": {
                                        "userId": user.databaseId,
                                        "confidentialPhone": storedData.fullModel?.confidentialPhone || "",
                                        "userPhone": storedData.fullModel?.userPhone || "",
                                        "userFax": storedData.fullModel?.userFax || "",
                                        "notesStiHiv": storedData.fullModel?.notesStiHiv || "",
                                        "hivRole": storedData.fullHivRoleIds || [],
                                        "stiRole": storedData.fullStiRoleIds || [],
                                        "userJurisdiction": parseInt(currentJurisdictionId, 10)
                                    }
                                }
                            };
                            
                            console.log('UPDATE USER GraphQL payload:', JSON.stringify(updatePayload, null, 2));
                            
                            // Clean up the temporary data
                            delete window.tempUserCreationData;
                            
                            // Send the update mutation to add the custom fields
                            $.ajax({
                                url: 'https://hivstiooj.cste.org/graphql',
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify(updatePayload),
                                dataType: 'json',
                                xhrFields: { withCredentials: true }
                            }).then(function(updateResponse) {
                                if (updateResponse.errors && updateResponse.errors.length > 0) {
                                    console.error('Error updating user custom fields:', updateResponse.errors);
                                    showNotification('Error updating user custom fields: ' + 
                                                     updateResponse.errors[0].message, 'warning');
                                } else {
                                    console.log('User custom fields updated successfully');
                                    
                                    // Update the local model with the roles if available
                                    if (updateResponse.data?.updateUserStdContact?.user?.stdContactDetails) {
                                        const details = updateResponse.data.updateUserStdContact.user.stdContactDetails;
                                        newUser.hivRole = details.hivRole?.nodes || [];
                                        newUser.stiRole = details.stiRole?.nodes || [];
                                    }
                                    
                                    // Refresh the grid to show updated data
                                    usersDataSource.read();
                                }
                            }).catch(function(error) {
                                console.error('AJAX error updating user custom fields:', error);
                                showNotification('Error updating user custom fields', 'error');
                            });
                            
                            return [newUser];
                        }
                        // Handle user update operation
                        else if (data.updateUserStdContact && data.updateUserStdContact.user) {
                            const user = data.updateUserStdContact.user;
                            return [{
                                id: user.id,
                                databaseId: user.databaseId,
                                firstName: user.firstName || "",
                                lastName: user.lastName || "",
                                email: user.email || "",
                                confidentialPhone: user.stdContactDetails?.confidentialPhone || "",
                                userPhone: user.stdContactDetails?.userPhone || "",
                                userFax: user.stdContactDetails?.userFax || "",
                                notesStiHiv: user.stdContactDetails?.notesStiHiv || "",
                                hivRole: user.stdContactDetails?.hivRole?.nodes || [],
                                stiRole: user.stdContactDetails?.stiRole?.nodes || []
                            }];
                        }
                        // Handle user delete operation
                        else if (data.deleteUser && data.deleteUser.deletedId) {
                            return [];
                        }
                        
                        return [];
                    },
                    model: {
                        id: "id",
                        fields: {
                            id: { editable: false, nullable: true },
                            databaseId: { editable: false, nullable: true },
                            firstName: { type: "string" },
                            lastName: { type: "string" },
                            email: { type: "string" },
                            confidentialPhone: { type: "string" },
                            userPhone: { type: "string" },
                            userFax: { type: "string" },
                            notesStiHiv: { type: "string" },
                            hivRole: { defaultValue: [] },
                            stiRole: { defaultValue: [] }
                        }
                    }
                },
                pageSize: 20,
                change: function(e) {
                    console.log('UsersDataSource change event:', e);
                }
            });

            $("#users_grid").kendoGrid({
                dataSource: usersDataSource,
                height: 550,
                scrollable: true,
                sortable: true,
                toolbar: ["create", "save", "cancel"],
                editable: "inline",
                save: function(e) {
                    console.log("Users grid save event triggered", e);
                    // Manually sync when save is clicked
                    if (e.model && e.model.dirty) {
                        console.log("Model is dirty, performing manual sync");
                        usersDataSource.sync();
                    }
                },
                columns: [
                    { field: "firstName", title: "First Name", width: 120 },
                    { field: "lastName", title: "Last Name", width: 120 },
                    { field: "email", title: "Email", width: 180 },
                    { field: "confidentialPhone", title: "Confidential Phone", width: 150 },
                    { field: "userPhone", title: "Phone", width: 120 },
                    { field: "userFax", title: "Fax", width: 120 },
                    { field: "notesStiHiv", title: "Notes", width: 180 },
                    { 
                        field: "hivRole", 
                        title: "HIV Roles", 
                        width: 180,
                        template: function(dataItem) {
                            return dataItem.hivRole && dataItem.hivRole.length ? 
                                dataItem.hivRole.map(r => r.name).join(', ') : '—';
                        },
                        editor: function(container, options) {
                            $('<input name="hivRole" />')
                                .appendTo(container)
                                .kendoMultiSelect({
                                    placeholder: "Select HIV Roles...",
                                    dataTextField: "name",
                                    dataValueField: "databaseId",
                                    dataSource: hivRolesData,
                                    value: options.model.hivRole.map(role => 
                                        typeof role === 'object' ? role.databaseId : role),
                                    change: function(e) {
                                        const selectedValues = e.sender.value();
                                        options.model.hivRole = [];
                                        selectedValues.forEach(value => {
                                            const roleObj = hivRolesData.find(r => String(r.databaseId) === String(value));
                                            if (roleObj) {
                                                options.model.hivRole.push({ 
                                                    id: roleObj.id,
                                                    databaseId: roleObj.databaseId,
                                                    name: roleObj.name
                                                });
                                            }
                                        });
                                        
                                        // Mark as dirty to ensure update and trigger direct sync
                                        options.model.dirty = true;
                                        console.log("Model marked dirty after HIV role change");
                                    }
                                });
                        }
                    },
                    { 
                        field: "stiRole", 
                        title: "STI Roles", 
                        width: 180,
                        template: function(dataItem) {
                            return dataItem.stiRole && dataItem.stiRole.length ? 
                                dataItem.stiRole.map(r => r.name).join(', ') : '—';
                        },
                        editor: function(container, options) {
                            $('<input name="stiRole" />')
                                .appendTo(container)
                                .kendoMultiSelect({
                                    placeholder: "Select STI Roles...",
                                    dataTextField: "name",
                                    dataValueField: "databaseId",
                                    dataSource: stiRolesData,
                                    value: options.model.stiRole.map(role => 
                                        typeof role === 'object' ? role.databaseId : role),
                                    change: function(e) {
                                        const selectedValues = e.sender.value();
                                        options.model.stiRole = [];
                                        selectedValues.forEach(value => {
                                            const roleObj = stiRolesData.find(r => String(r.databaseId) === String(value));
                                            if (roleObj) {
                                                options.model.stiRole.push({ 
                                                    id: roleObj.id,
                                                    databaseId: roleObj.databaseId,
                                                    name: roleObj.name
                                                });
                                            }
                                        });
                                        
                                        // Mark as dirty to ensure update and trigger direct sync
                                        options.model.dirty = true;
                                        console.log("Model marked dirty after STI role change");
                                    }
                                });
                        }
                    },
                    { command: ["edit", "destroy"], title: "&nbsp;", width: "130px" }
                ]
            });
        }
    });
</script>
