<script>
    // GraphQL queries for jurisdiction data
    var READ_JURISDICTION_QUERY = `
    query GetJurisdiction($databaseId: Int!) {
      jurisdictions(where: {id: $databaseId}) {
        edges {
          node {
            id
            databaseId
            title
            jurisdictionDetails {
              addressJurisdiction
              agencyName
              faxJurisdiction
              fipsCode
              phoneJurisdiction
            }
            modified
          }
        }
      }
    }
    `;
    
    var UPDATE_JURISDICTION_QUERY = `
mutation UpdateJurisdiction($input: UpdateJurisdictionInput!) {
  updateJurisdiction(input: $input) {
    jurisdiction {
      id
      databaseId
      title
      jurisdictionDetails {
        addressJurisdiction
        agencyName
        faxJurisdiction
        fipsCode
        phoneJurisdiction
      }
    }
  }
}
    `;
    
    // Get current user's jurisdiction
    async function getCurrentUserJurisdiction() {
        const query = `
            query CurrentUserJurisdiction {
                viewer {
                    stdContactDetails {
                        userJurisdiction {
                            nodes {
                                databaseId
                                id
                                ... on Jurisdiction {
                                    id
                                    title
                                    jurisdictionDetails {
                                        addressJurisdiction
                                        agencyName
                                        faxJurisdiction
                                        fipsCode
                                        phoneJurisdiction
                                    }
                                }
                            }
                        }
                    }
                }
            }
        `;
    
        try {
            console.log('Executing getCurrentUserJurisdiction...');
            const response = await $.ajax({
                url: 'https://hivstiooj.cste.org/graphql',
                method: 'POST',
                data: JSON.stringify({
                    query: query
                }),
                contentType: 'application/json',
                dataType: 'json',
                xhrFields: {
                    withCredentials: true
                },
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            console.log('Full GraphQL response for user jurisdiction:', response);
            
            if (response.errors) {
                console.error('GraphQL errors in getCurrentUserJurisdiction:', response.errors);
                throw new Error(response.errors[0]?.message || 'Unknown GraphQL error');
            }
            
            const jurisdictionNode = response?.data?.viewer?.stdContactDetails
                ?.userJurisdiction?.nodes?.[0];
                
            console.log('Jurisdiction node from response:', jurisdictionNode);
                
            if (!jurisdictionNode) {
                throw new Error('No jurisdiction found for current user');
            }
            
            // Return the full jurisdiction node rather than just the ID
            return jurisdictionNode;
        } catch (error) {
            console.error('Error getting current user jurisdiction:', error);
            console.error('Error response text:', error.responseText || 'No response text available');
            return null;
        }
    }
    
    // Helper function to show notifications
    function showNotification(message, type = 'error') {
        console.log(`Showing notification: ${message} (type: ${type})`);
        if (window.kendo && kendo.ui.Notification) {
            const notification = new kendo.ui.Notification({
                position: {
                    top: 30,
                    right: 30
                }
            });
            notification[type](message);
        } else {
            console[type === 'error' ? 'error' : 'log'](message);
        }
    }
    
    $(document).ready(function() {
        console.log('Document ready, initializing application...');
        // Fetch the current user's jurisdiction
        getCurrentUserJurisdiction()
            .then(jurisdictionData => {
                console.log('Retrieved jurisdiction data:', jurisdictionData);
                if (!jurisdictionData) {
                    throw new Error("Could not determine user's jurisdiction");
                }
                
                const jurisdictionId = jurisdictionData.databaseId;
                console.log('Using jurisdictionId:', jurisdictionId);
                
                var dataSource = new kendo.data.DataSource({
                    transport: {
                        read: {
                            contentType: "application/json",
                            url: "https://hivstiooj.cste.org/graphql",
                            type: "POST",
                            data: function() {
                                console.log('READ operation with jurisdictionId:', jurisdictionId);
                                const payload = { 
                                    query: READ_JURISDICTION_QUERY,
                                    variables: { "databaseId": jurisdictionId }
                                };
                                console.log('READ payload:', JSON.stringify(payload));
                                return payload;
                            },
                            success: function(response) {
                                console.log('GraphQL READ response received:', response);
                                if (response.data) {
                                    console.log('Data from server:', JSON.stringify(response.data, null, 2));
                                    // Check if we have the expected data structure
                                    if (response.data.jurisdictions && 
                                        response.data.jurisdictions.edges && 
                                        response.data.jurisdictions.edges.length > 0) {
                                        console.log('Found jurisdiction edges:', response.data.jurisdictions.edges.length);
                                    } else {
                                        console.warn('Expected data structure not found in response');
                                    }
                                } else {
                                    console.warn('No data in response');
                                }
                            },
                            error: function(e) {
                                console.error("Error in read operation:", e);
                                console.error("Error details:", e.xhr ? e.xhr.responseText : e);
                                showNotification("Failed to retrieve jurisdiction data. Please try again.");
                            },
                            dataType: "json"
                        },
                        update: {
                            contentType: "application/json",
                            url: "https://hivstiooj.cste.org/graphql",
                            type: "POST",
                            data: function(model) {
    console.log('UPDATE operation data payload:', model);
    
    // Convert the database ID to a global ID format
    const globalId = btoa(`post:${jurisdictionId}`);
    console.log('Converting database ID to global ID:', jurisdictionId, '->', globalId);
    
    const payload = {
        query: UPDATE_JURISDICTION_QUERY,
        variables: {
            "input": {
                "id": globalId,  // Include ID inside the input object
                "title": model.title.rendered,
                "agencyName": model.jurisdictionDetails.agencyName,
                "addressJurisdiction": model.jurisdictionDetails.addressJurisdiction,
                "phoneJurisdiction": model.jurisdictionDetails.phoneJurisdiction,
                "fipsCode": model.jurisdictionDetails.fipsCode,
                "faxJurisdiction": model.jurisdictionDetails.faxJurisdiction
            }
        }
    };
    console.log('UPDATE payload:', JSON.stringify(payload));
    return payload;
},
                            success: function(response) {
                                console.log('GraphQL UPDATE response received:', response);
                                if (response.data && response.data.updateJurisdiction) {
                                    console.log('Update successful:', JSON.stringify(response.data.updateJurisdiction, null, 2));
                                    showNotification("Jurisdiction updated successfully.", "success");
                                } else {
                                    console.warn('Unexpected response format for update');
                                }
                            },
                            error: function(e) {
                                console.error("Error in update operation:", e);
                                console.error("Error details:", e.xhr ? e.xhr.responseText : e);
                                showNotification("Failed to update jurisdiction data. Please try again.");
                            }
                        },
                        parameterMap: function(options, operation) {
                            console.log('parameterMap called with operation:', operation, 'options:', options);
                            return kendo.stringify({
                                query: options.query,
                                variables: options.variables
                            });
                        }
                    },
                    schema: {
                        data: function(response) {
        console.log('Schema data response received:', response);
        
        // Check for GraphQL errors
        if (response.errors && response.errors.length > 0) {
            console.error('GraphQL errors:', response.errors);
            showNotification('Error retrieving data: ' + response.errors[0].message);
            return [];
        }
        
        var data = response.data;
        console.log('Parsed data object:', data);

        if (!data) {
            console.error('No data received in response');
            return [];
        }

        // Handle read operation response
        if (data.jurisdictions && data.jurisdictions.edges && data.jurisdictions.edges.length > 0) {
            console.log('Processing jurisdictions data from read operation');
            // Extract the node from the first edge
            const node = data.jurisdictions.edges[0].node;
            console.log('Extracted node:', node);
            
            // Ensure the node has the expected structure
            if (!node.title || !node.jurisdictionDetails) {
                console.error('Node does not have expected structure:', node);
                return [];
            }
            
            // Transform the node to match the expected model format
            const transformedNode = {
                id: node.id,
                databaseId: node.databaseId,
                title: { rendered: node.title },
                modified: node.modified,
                jurisdictionDetails: node.jurisdictionDetails
            };
            
            console.log('Transformed node for grid:', transformedNode);
            return [transformedNode];
        }
        // Handle update operation response
        else if (data.updateJurisdiction && data.updateJurisdiction.jurisdiction) { 
            console.log('Found updateJurisdiction data:', data.updateJurisdiction.jurisdiction);
            // Format the update response to match the expected model structure
            const jurisdiction = data.updateJurisdiction.jurisdiction;
            const transformedNode = {
                id: jurisdiction.id,
                databaseId: jurisdiction.databaseId,
                title: { rendered: jurisdiction.title }, // Convert simple title to object with rendered property
                modified: jurisdiction.modified || new Date().toISOString(),
                jurisdictionDetails: jurisdiction.jurisdictionDetails
            };
            console.log('Transformed update node for grid:', transformedNode);
            return [transformedNode]; 
        }
        else {
            console.warn('No jurisdiction or updateJurisdiction data found in response', data);
            return [];
        }
    },
                        model: {
                            id: "id",
                            fields: {
                                id: { editable: false, nullable: true },
                                title: {
                                    defaultValue: { rendered: "" },
                                    validation: { required: true }
                                },
                                modified: { type: "string", validation: { required: false } },
                                jurisdictionDetails: {
                                    defaultValue: {
                                        agencyName: "",
                                        addressJurisdiction: "",
                                        phoneJurisdiction: "",
                                        fipsCode: "",
                                        faxJurisdiction: ""
                                    },
                                    fields: {
                                        agencyName: { type: "string", validation: { required: true } },
                                        addressJurisdiction: { type: "string", validation: { required: true } },
                                        phoneJurisdiction: { type: "string", validation: { required: true } },
                                        fipsCode: { type: "string" },
                                        faxJurisdiction: { type: "string" }
                                    }
                                }
                            }
                        }
                    },
                    error: function(e) {
                        console.error("DataSource error:", e);
                        showNotification("An error occurred with the data source. Please try again.");
                    },
                    requestStart: function() {
                        console.log("DataSource request started");
                    },
                    requestEnd: function(e) {
                        console.log("DataSource request ended:", e);
                    },
                    pageSize: 20
                });
    
                console.log('Creating Kendo Grid with dataSource:', dataSource);
                $("#juris_grid").kendoGrid({
                    dataSource: dataSource,
                    height: 550,
                    sortable: true,
                    toolbar: ["save", "cancel"],
                    editable: "inline",
                    columns: [
                        { field: "title.rendered", title: "Jurisdiction Name" },
                        { field: "jurisdictionDetails.fipsCode", title: "FIPS Code" },
                        { field: "jurisdictionDetails.agencyName", title: "Agency Name" },
                        { field: "jurisdictionDetails.addressJurisdiction", title: "Agency Address" },
                        { field: "jurisdictionDetails.phoneJurisdiction", title: "Agency Phone (Main)" },
                        { field: "jurisdictionDetails.faxJurisdiction", title: "Agency Fax" },
                        { command: ["edit"], title: "&nbsp;", width: "250px" }
                    ],
                    dataBound: function(e) {
                        console.log("Grid data bound event fired");
                        const view = e.sender.dataSource.view();
                        console.log("Grid data view:", view);
                        if (view.length === 0) {
                            console.warn("No data items to display in grid");
                            // Add a custom message to the grid if empty
                            const emptyMessage = $('<div class="k-grid-norecords">No jurisdiction data available.</div>');
                            e.sender.element.find(".k-grid-content").append(emptyMessage);
                        }
                    }
                });
                console.log('Kendo Grid initialized');
                
                // Force a read on the dataSource to ensure data is loaded
                dataSource.read();
                console.log('Manually triggered dataSource read');
            })
            .catch(error => {
                console.error("Error initializing application:", error);
                console.error("Error details:", error.stack || error.message || 'No additional error details');
                showNotification("Failed to initialize application. Please refresh and try again.");
            });
    });
    </script>